<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Interactieve Speurtocht Kaart</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100vw; }

        /* Bedieningsknoppen onderaan */
        .controls { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            z-index: 1000; display: flex; gap: 10px; width: 90%; max-width: 400px; 
        }
        .btn { 
            flex: 1; padding: 15px; background: #000; color: #fff; border: 2px solid #555; 
            border-radius: 12px; font-weight: bold; text-align: center; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); text-transform: uppercase; font-size: 12px;
        }
        .btn-check { background: #800020; border-color: #400010; }

        /* Info knop rechtsboven */
        .btn-log { 
            position: absolute; top: 20px; right: 20px; z-index: 1000; 
            background: #fff; border: 2px solid #000; border-radius: 50%; 
            width: 50px; height: 50px; display: flex; align-items: center; 
            justify-content: center; font-size: 20px; text-decoration: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Nummering op de kaart */
        .area-number { 
            background: none; border: none; color: white; font-weight: bold; 
            font-size: 16px; text-shadow: 2px 2px 4px #000; 
        }

        #status-msg { 
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%); 
            z-index: 1001; background: rgba(255,255,255,0.9); padding: 5px 15px; 
            border-radius: 20px; font-size: 12px; display: none; border: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div id="status-msg">GPS signaal zoeken...</div>
    <a href="logboek.html" class="btn-log">üìñ</a>

    <div id="map"></div>

    <div class="controls">
        <div class="btn" onclick="startGps()">üõ∞Ô∏è Start GPS</div>
        <div class="btn btn-check" onclick="checkCheckpoint()">üîì Check Locatie</div>
    </div>

    <script>
        // --- CONFIGURATIE ---
        const scriptURL = 'JOUW_APPS_SCRIPT_URL_HIER'; // VERVANG DIT DOOR JE WEB APP URL
        
        // 1. Teamnaam beheer
        let teamnaam = localStorage.getItem('teamnaam');
        if (!teamnaam) {
            teamnaam = prompt("Welkom! Wat is jullie teamnaam?");
            if (teamnaam) {
                localStorage.setItem('teamnaam', teamnaam);
            } else {
                teamnaam = "Anoniem Team";
            }
        }

        // 2. De Locaties (Zorg dat 'name' exact matcht met je Google Sheet!)
        const areas = [
            {
                name: "De Vijver",
                riddle: "Loop naar de visplek op de brug.",
                coords: [[52.1667, 4.5260], [52.1681, 4.5293], [52.1666, 4.5303], [52.1665, 4.5287]],
                targetLat: 52.16695,
                targetLon: 4.52805,
                url: "locatiepagina.html"
            },
            {
                name: "Dwars",
                riddle: "Kruispunt van de Y-splitsing.",
                coords: [[52.1689, 4.5353], [52.1678, 4.5374], [52.1678, 4.5345]],
                targetLat: 52.16853,
                targetLon: 4.53587,
                url: "locatiepagina.html"
            }
        ];

        // --- KAART INITIALISATIE ---
        var map = L.map('map', { zoomControl: false }).setView([52.1678, 4.5338], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const polygonLayers = {};

        // Gebieden tekenen
        areas.forEach((area, index) => {
            var polygon = L.polygon(area.coords, { 
                color: '#800020', 
                fillColor: '#800020', 
                fillOpacity: 0.4, 
                weight: 3 
            }).addTo(map);

            polygonLayers[area.name] = polygon;
            polygon.bindPopup(`<b>Locatie ${index + 1}: ${area.name}</b><br>${area.riddle}`);
            
            var center = polygon.getBounds().getCenter();
            L.marker(center, { 
                icon: L.divIcon({ className: 'area-number', html: index + 1 }), 
                interactive: false 
            }).addTo(map);
        });

        // --- DATA SYNCHRONISATIE ---
        async function loadProgress() {
            try {
                const response = await fetch(`${scriptURL}?teamnaam=${encodeURIComponent(teamnaam)}`);
                const voltooideNamen = await response.json();

                voltooideNamen.forEach(naam => {
                    if (polygonLayers[naam]) {
                        polygonLayers[naam].setStyle({
                            color: '#2ecc71',
                            fillColor: '#2ecc71',
                            fillOpacity: 0.6
                        });
                    }
                });
            } catch (error) {
                console.log("Kon voortgang niet laden. Geen probleem, we gaan door.");
            }
        }

        loadProgress();

        // --- GPS LOGICA ---
        var userLat, userLon, userMarker;

        function startGps() {
            document.getElementById('status-msg').style.display = 'block';
            if (!navigator.geolocation) { alert("GPS niet ondersteund"); return; }
            
            navigator.geolocation.watchPosition((pos) => {
                document.getElementById('status-msg').style.display = 'none';
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                
                if (userMarker) {
                    userMarker.setLatLng([userLat, userLon]);
                } else {
                    userMarker = L.circleMarker([userLat, userLon], { 
                        radius: 10, color: '#fff', weight: 4, fillColor: '#3498db', fillOpacity: 1 
                    }).addTo(map);
                    map.flyTo([userLat, userLon], 17);
                }
            }, (err) => { alert("GPS Fout: " + err.message); }, { enableHighAccuracy: true });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            var R = 6371000;
            var dLat = (lat2-lat1) * Math.PI/180;
            var dLon = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function checkCheckpoint() {
            if (!userLat) { alert("Zet eerst je GPS aan!"); return; }
            
            let found = false;
            areas.forEach(area => {
                const distance = getDistance(userLat, userLon, area.targetLat, area.targetLon);
                if (distance <= 30) { // 30 meter marge
                    found = true;
                    sessionStorage.setItem('locationName', area.name);
                    sessionStorage.setItem('checkpointReached', 'true');
                    window.location.href = area.url;
                }
            });
            
            if (!found) alert("Je bent nog niet dichtbij genoeg bij een van de locaties (loop tot binnen de 30 meter).");
        }
    </script>
</body>
</html>
