<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Kaart Van Vosserwoude</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Georgia', serif; background: #222; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .leaflet-tile-container { filter: sepia(0.8) brightness(0.8) contrast(1.2); }
        #map-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); background-color: rgba(101, 67, 33, 0.1); mix-blend-mode: multiply; box-shadow: inset 0 0 100px rgba(0,0,0,0.5); }
        
        /* Namen op de kaart in plaats van nummers */
        .area-label { 
            font-size: 11px; 
            font-weight: bold; 
            color: #000; 
            text-align: center; 
            text-shadow: 1px 1px 2px white, -1px -1px 2px white; 
            white-space: nowrap;
        }

        .controls { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; gap: 10px; width: 95%; pointer-events: none; }
        button { flex: 1; padding: 18px 5px; border: 2px solid #555; border-radius: 12px; font-weight: bold; font-size: 13px; background: #000; color: #fff; pointer-events: auto; cursor: pointer; text-transform: uppercase; font-family: 'Georgia', serif; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        button:active { background: #333; transform: translateY(2px); }
        .top-nav { position: fixed; top: 15px; right: 15px; z-index: 10001; display: flex; gap: 10px; }
        .btn-round { width: 45px; height: 45px; border-radius: 50%; background: #000; color: #fff; border: 2px solid #555; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .modal { display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .modal-content { background-color: #f4e4bc; margin: 8% auto; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; border: 3px double #5d2e0a; text-align: center; color: #5d2e0a; font-family: 'Georgia', serif; max-height: 82vh; overflow-y: auto; box-sizing: border-box; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        .modal-content h2 { color: #800020; margin-top: 0; font-size: 22px; letter-spacing: 1px; }
        .modal-content p { line-height: 1.6; font-size: 15px; text-align: left; margin-bottom: 15px; }
        
        /* Popup Styling voor Hint */
        .hint-popup-container { max-height: 150px; overflow-y: auto; font-style: italic; color: #1e8449; }
        #status-msg { position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 10000; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; }
    </style>
</head>
<body>

<div id="status-msg">GPS Signaal zoeken...</div>
<div id="map-overlay"></div>

<div class="top-nav">
    <div class="btn-round" onclick="toggleStoryModal(true)">üìñ</div>
    <div class="btn-round" onclick="toggleInfoModal(true)">?</div>
</div>

<div id="infoModal" class="modal">
    <div class="modal-content">
        <h2>BEKNOPTE UITLEG</h2>
        <p>Klik op een gebied om het raadsel te krijgen. Zet je <b>GPS</b> aan om je eigen positie te zien. Ben je op de juiste plek? Druk op <b>CHECK</b>! Bezochte locaties kleuren groen en tonen de gevonden aanwijzing.</p>
        <button style="width:100%; background: #800020; color: white; padding: 15px; border-radius: 10px; border: 2px solid #555;" onclick="toggleInfoModal(false)">BEGREPEN</button>
    </div>
</div>

<div id="storyModal" class="modal">
    <div class="modal-content">
        <h2>DE VLOEK VAN VOSSERWOUDE</h2>
        <p>Welkom rechercheurs. Vosserwoude is in rep en roer na een mysterieuze moord. Ondervraag de bewoners, verzamel aanwijzingen en ontmasker de dader voordat de zon ondergaat.</p>
        <button style="width:100%; background: #800020; color: white; padding: 15px; border-radius: 10px; font-weight: bold; border: 2px solid #555; cursor: pointer;" onclick="toggleStoryModal(false)">START HET ONDERZOEK</button>
    </div>
</div>

<div id="map"></div>

<div class="controls">
  <button onclick="startGps()">üìç GPS</button>
  <button onclick="checkCheckpoint()" style="background: #800020;">‚úÖ CHECK</button>
  <button onclick="window.location.href='logboek.html'">üèÜ LOGBOEK</button>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyTIooB83Vc70VaVwv2cI-uwg2ZRlgoANskNTSONicyuy6d2_LsMyFrs6hHTbEbxRgC/exec';
    let teamnaam = localStorage.getItem('teamnaam');

    if (!teamnaam || teamnaam.trim() === "") { window.location.href = 'index.html'; }

    function toggleInfoModal(show) { document.getElementById('infoModal').style.display = show ? 'block' : 'none'; }
    function toggleStoryModal(show) { 
        document.getElementById('storyModal').style.display = show ? 'block' : 'none'; 
        if (!show) localStorage.setItem('storyRead', 'true');
    }

    window.onload = function() { if (!localStorage.getItem('storyRead')) toggleStoryModal(true); };

    var map = L.map('map', { zoomControl: false }).setView([52.1678, 4.5338], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let areas = [];
    const polygonLayers = {};
    const markerLayers = {};
    var userLat, userLon, userMarker;

    async function updateData() {
        try {
            const response = await fetch(`${scriptURL}?teamnaam=${encodeURIComponent(teamnaam)}`);
            const data = await response.json();
            
            data.locaties.forEach((area) => {
                const isVoltooid = data.voltooid.includes(area.name);
                
                // 1. Maak of update de Polygoon
                if (!polygonLayers[area.name]) {
                    const poly = L.polygon(area.coords, { color: '#800020', fillColor: '#800020', fillOpacity: 0.4 }).addTo(map);
                    polygonLayers[area.name] = poly;
                    
                    // Label in het midden (Naam van de locatie)
                    const center = poly.getBounds().getCenter();
                    markerLayers[area.name] = L.marker(center, { 
                        icon: L.divIcon({ className: 'area-label', html: area.name }), 
                        interactive: false 
                    }).addTo(map);
                }

                // 2. Update kleur en popup inhoud
                const poly = polygonLayers[area.name];
                if (isVoltooid) {
                    poly.setStyle({ color: '#27ae60', fillColor: '#27ae60' });
                    poly.bindPopup(`<b>‚úÖ ${area.name}</b><br><div class="hint-popup-container">"${area.hint}"</div>`);
                } else {
                    poly.bindPopup(`<b>üîç ${area.name}</b><br>${area.riddle}`);
                }
            });
            areas = data.locaties;
        } catch (e) { console.log("Synchronisatie fout"); }
    }

    function startGps() {
        document.getElementById('status-msg').style.display = 'block';
        navigator.geolocation.watchPosition((pos) => {
            document.getElementById('status-msg').style.display = 'none';
            userLat = pos.coords.latitude; userLon = pos.coords.longitude;
            if (userMarker) { userMarker.setLatLng([userLat, userLon]); } 
            else { userMarker = L.circleMarker([userLat, userLon], { radius: 8, color: '#fff', weight: 4, fillColor: '#3498db', fillOpacity: 1 }).addTo(map); map.flyTo([userLat, userLon], 17); }
        }, (err) => alert("Zet GPS aan"), { enableHighAccuracy: true });
    }

    function checkCheckpoint() {
        if (!userLat) return alert("Start eerst GPS!");
        const currentArea = areas.find(a => map.distance([userLat, userLon], [a.targetLat, a.targetLon]) <= 35);
        if (currentArea) {
            if (polygonLayers[currentArea.name].options.color === '#27ae60') alert("Deze aanwijzing heb je al in je logboek!");
            else { sessionStorage.setItem('locationName', currentArea.name); window.location.href = 'locatiepagina.html'; }
        } else alert("Je bent niet dichtbij genoeg bij een bewoner.");
    }

    updateData();
    setInterval(updateData, 15000); 
</script>
</body>
</html>
