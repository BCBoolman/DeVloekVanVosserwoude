<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>De Vloek Van Vosserwoude: Aanmelden</title>
    <style>
        /* Basis styling */
        body { 
            margin: 0; padding: 0; 
            font-family: 'Georgia', serif; 
            background: #222; 
            color: #f4e4bc; 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; width: 100vw;
            overflow: hidden;
            position: relative;
        }

        #map-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1; pointer-events: none; 
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); 
            background-color: rgba(101, 67, 33, 0.1); 
            mix-blend-mode: multiply; 
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8); 
        }

        .login-card {
            background: #2a2a2a;
            padding: 35px 25px;
            border-radius: 15px;
            border: 3px double #800020;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            text-align: center;
            width: 85%;
            max-width: 340px;
            z-index: 10;
            position: relative;
        }

        h1 { color: #800020; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px; font-size: 20px; }
        .main-p { font-size: 13px; margin-bottom: 20px; line-height: 1.4; color: #f4e4bc; }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            border: 2px solid #555;
            background: #f4e4bc;
            color: #5d2e0a;
            font-size: 18px;
            font-family: 'Georgia', serif;
            box-sizing: border-box;
            text-align: center;
            font-weight: bold;
        }

        .btn-large {
            width: 100%;
            padding: 18px 5px;
            border: 2px solid #555 !important;
            border-radius: 12px;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            cursor: pointer;
            font-family: 'Georgia', serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            margin-bottom: 15px;
            transition: 0.2s;
            display: block;
            box-sizing: border-box;
        }

        .start-btn { background: #800020; color: white; }
        .uitleg-btn { background: #000; color: #fff; }
        .btn-large:active { transform: translateY(2px); filter: brightness(1.2); }
        .game-icon { width: 60px; height: auto; margin-bottom: 10px; }

        .modal { 
            display: none; position: fixed; z-index: 10002; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); 
        }
        
        .modal-content { 
            background-color: #f4e4bc; margin: 20% auto; padding: 25px; 
            border-radius: 15px; width: 85%; max-width: 350px; 
            border: 3px double #5d2e0a; text-align: center; 
        }

        .modal-content h2 { color: #800020; margin-top: 0; font-size: 18px; }
        .modal-content p { color: #5d2e0a !important; font-size: 15px !important; line-height: 1.5; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="map-overlay"></div>

<div class="login-card">
    <img src="images/placeholder.jpg" alt="Icoon" class="game-icon">
    <h1>DE VLOEK VAN VOSSERWOUDE</h1>
    <p class="main-p">Voer jullie teamnaam in. Gebruik op elke telefoon die wordt gebruikt binnen het team exact dezelfde naam!</p>
    
    <input type="text" id="teamInput" placeholder="TEAMNAAM..." autocomplete="off">
    
    <button class="btn-large start-btn" onclick="startSpel()">START DE VOSSENJACHT</button>
    <button class="btn-large uitleg-btn" onclick="toggleModal(true)">HOE WERKT HET SPEL?</button>
</div>

<div id="uitlegModal" class="modal">
    <div class="modal-content">
        <h2>SPELUITLEG</h2>
        <p>Welkom in dit Levend Cluedo / Vossenjacht spel! Jullie gaan aan de slag om het mysterie van Vosserwoude op te lossen. Gebruik de kaart en de GPS om bewoners te vinden en raadsels op te lossen.</p>
        <button class="btn-large start-btn" style="width:100%; margin-bottom: 0;" onclick="toggleModal(false)">BEGREPEN</button>
    </div>
</div>

<script>
    let uitlegBekeken = false;

    function toggleModal(show) {
        document.getElementById('uitlegModal').style.display = show ? 'block' : 'none';
        if (show) { uitlegBekeken = true; }
    }

    async function startSpel() {
        const input = document.getElementById('teamInput').value;
        const genormaliseerdeNaam = input.trim().toLowerCase();
        
        if (genormaliseerdeNaam.length < 3) {
            alert("Kies een teamnaam van minstens 3 tekens.");
            return;
        }

        if (!uitlegBekeken) {
            const bevestigen = confirm("Jullie hebben niet gekeken hoe het spel werkt, weten jullie zeker dat jullie willen starten?");
            if (!bevestigen) return;
        }

        const startBtn = document.querySelector('.start-btn');
        const origineleTekst = startBtn.innerText;
        startBtn.innerText = "CONTROLE...";
        startBtn.disabled = true;

        // Gebruik de URL van je Google Apps Script
        const scriptURL = "https://script.google.com/macros/s/AKfycbz-6eQ2FGJSzQbcxvhVXYZKhw_d8OZHCmCdcGn2w5SbSmUpC0ZgYJL0nSMUb8b7G_Me/exec";
        
        try {
            // 1. Eerst controleren we de status van het team
            const response = await fetch(`${scriptURL}?teamnaam=${encodeURIComponent(genormaliseerdeNaam)}`);
            const data = await response.json();

            // 2. Als het team al klaar is (score == maxScore), blokkeren we de toegang
            if (data.allesVoltooid === true) {
                alert("Dit team heeft het mysterie van Vosserwoude al opgelost! De toegang tot de kaart is gesloten voor dit team.");
                startBtn.innerText = origineleTekst;
                startBtn.disabled = false;
                return; 
            }

            // 3. Als het team nog niet klaar is (of nieuw is), registreren we de starttijd
            // We doen dit nu met een normale fetch zodat we zeker weten dat het gelukt is
            await fetch(`${scriptURL}?action=registerStart&teamnaam=${encodeURIComponent(genormaliseerdeNaam)}`);

            // 4. Alles OK? Dan pas opslaan en doorsturen
            localStorage.setItem('teamnaam', genormaliseerdeNaam);
            window.location.href = 'kaart.html';

        } catch (e) {
            console.error(e);
            // Bij een fout (bijv. nieuw team dat nog niet in de lijst staat) proberen we toch te starten
            localStorage.setItem('teamnaam', genormaliseerdeNaam);
            window.location.href = 'kaart.html';
        }
    }

    document.getElementById('teamInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') startSpel();
    });
</script>

</body>
</html>
