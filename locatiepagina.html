<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locatie Gevonden!</title>
    <style>
        body { background: #f4e4bc; font-family: 'Georgia', serif; text-align: center; padding: 20px; color: #5d2e0a; margin: 0; }
        .box { border: 3px double #5d2e0a; padding: 25px; display: inline-block; border-radius: 15px; background: rgba(255,255,255,0.2); max-width: 85%; margin-top: 20px; }
        .char-img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #5d2e0a; object-fit: cover; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .button-container { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; align-items: center; }
        .btn-custom { width: 100%; max-width: 280px; padding: 18px 5px; border: 2px solid #555; border-radius: 12px; font-weight: bold; font-size: 13px; background: #000; color: #fff; cursor: pointer; text-transform: uppercase; text-decoration: none; display: block; }
        .btn-main { background: #800020; border-color: #400010; }
        .hidden { display: none; }
        input[type="text"] { width: 100%; max-width: 260px; padding: 15px; border-radius: 10px; border: 2px solid #5d2e0a; font-size: 16px; text-align: center; }
        #timer-msg { color: #800020; font-weight: bold; margin-top: 10px; padding: 10px; border: 1px dashed #800020; border-radius: 8px; display: none; }
    </style>
</head>
<body>

    <div id="denied-msg">
        <h1>Toegang Geweigerd!</h1>
        <p>Activeer deze locatie eerst via de kaart.</p>
        <a href="kaart.html" class="btn-custom" style="margin: 0 auto;">Terug naar de kaart</a>
    </div>

    <div id="content" class="hidden">
        <img id="char-foto" src="" class="char-img" alt="Karakter">
        <div class="box">
            <h2 id="loc-display">...</h2> 

            <div id="input-section">
                <p id="vraag-tekst">Gegevens ophalen...</p>
                <div id="timer-msg"></div> <div id="form-controls">
                    <input type="text" id="answer-input" placeholder="Typ je antwoord...">
                    <div class="button-container">
                        <button id="submit-btn" onclick="sendAnswer()" class="btn-custom btn-main">Antwoord Controleren</button>
                    </div>
                </div>
                <div class="button-container">
                    <a href="kaart.html" class="btn-custom" style="background: #444;">üó∫Ô∏è Terug naar kaart</a>
                </div>
            </div>

            <div id="success-section" class="hidden">
                <h2 style="color: green;">‚úì CORRECT!</h2>
                <p id="uitleg-tekst"></p>
                <div class="button-container">
                    <a href="kaart.html" class="btn-custom">Volgende Locatie</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VERVANG DEZE URL DOOR JE EIGEN GOOGLE APPS SCRIPT URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbw17lDaT0QUhx8XGvVHtNPQUs4CEAlsP5CrhRGPAERSZteRzyEP2-AQvGvqhO5gsduN/exec';
        let locatieUitleg = "";

        async function checkAccess() {
            const locName = sessionStorage.getItem('locationName');
            const teamnaam = localStorage.getItem('teamnaam');

            if (!teamnaam) {
                alert("Meld je eerst aan met een teamnaam.");
                window.location.href = 'index.html';
                return;
            }

            if (sessionStorage.getItem('checkpointReached') === 'true' && locName) {
                document.getElementById('denied-msg').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
                document.getElementById('loc-display').innerText = locName;
                
                try {
                    const res = await fetch(`${scriptURL}?getDetails=${encodeURIComponent(locName)}&teamnaam=${encodeURIComponent(teamnaam)}`);
                    const data = await res.json();
                    
                    document.getElementById('char-foto').src = data.foto || 'https://via.placeholder.com/120';
                    document.getElementById('vraag-tekst').innerText = data.vraag;
                    locatieUitleg = data.uitleg;

                    // CHECK OP BLOKKADE
                    if (data.blokkade > 0) {
                        document.getElementById('form-controls').classList.add('hidden');
                        const msg = document.getElementById('timer-msg');
                        msg.style.display = 'block';
                        msg.innerText = `‚ùå Deze locatie is geblokkeerd door een fout antwoord. Probeer het over ${data.blokkade} minuten opnieuw.`;
                    }
                } catch (error) {
                    console.error(error);
                    document.getElementById('vraag-tekst').innerText = "Fout bij ophalen gegevens. Check je verbinding.";
                }
            }
        }

        async function sendAnswer() {
            const btn = document.getElementById('submit-btn');
            const answer = document.getElementById('answer-input').value.trim();
            const locationId = sessionStorage.getItem('locationName');
            const teamnaam = localStorage.getItem('teamnaam');

            if (!answer) {
                alert("Vul een antwoord in.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Controleren...";

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({ teamnaam, locatieId, antwoord: answer })
                });

                const result = await response.text();

                if (result === "CORRECT") {
                    document.getElementById('input-section').classList.add('hidden');
                    document.getElementById('uitleg-tekst').innerText = locatieUitleg;
                    document.getElementById('success-section').classList.remove('hidden');
                } else if (result.startsWith("WAIT")) {
                    const min = result.split(":")[1];
                    alert(`Nog even geduld! Je moet nog ${min} minuten wachten.`);
                    location.reload();
                } else {
                    alert("Helaas! Dat is niet het juiste antwoord. Deze locatie is nu 10 minuten geblokkeerd.");
                    location.reload(); 
                }
            } catch (error) {
                console.error(error);
                alert("Verbindingsfout.");
                btn.disabled = false;
                btn.innerText = "Antwoord Controleren";
            }
        }

        window.onload = checkAccess;
    </script>
</body>
</html>
